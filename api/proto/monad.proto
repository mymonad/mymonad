syntax = "proto3";

package monad;

option go_package = "github.com/mymonad/mymonad/api/proto";

// MonadStore is the IPC service exposed by the Ingestion Daemon.
service MonadStore {
  // GetMonad returns the current encrypted Monad.
  rpc GetMonad(GetMonadRequest) returns (GetMonadResponse);

  // WatchMonad streams updates when the Monad changes.
  rpc WatchMonad(WatchMonadRequest) returns (stream MonadUpdate);

  // Status returns the ingestion daemon status.
  rpc Status(StatusRequest) returns (StatusResponse);
}

message GetMonadRequest {}

message GetMonadResponse {
  bytes encrypted_monad = 1;
  int64 version = 2;
  int64 last_updated = 3; // Unix timestamp
}

message WatchMonadRequest {}

message MonadUpdate {
  bytes encrypted_monad = 1;
  int64 version = 2;
  int64 timestamp = 3;
}

message StatusRequest {}

message StatusResponse {
  bool ready = 1;
  int64 documents_indexed = 2;
  int64 last_scan_timestamp = 3;
  string state = 4; // "idle", "scanning", "embedding"
}

// AgentService is the IPC service exposed by the Agent Daemon.
service AgentService {
  // Status returns the agent's current status.
  rpc Status(AgentStatusRequest) returns (AgentStatusResponse);

  // Peers returns connected peers.
  rpc Peers(PeersRequest) returns (PeersResponse);

  // Bootstrap manually connects to a peer.
  rpc Bootstrap(BootstrapRequest) returns (BootstrapResponse);

  // Identity returns the local identity info.
  rpc Identity(IdentityRequest) returns (IdentityResponse);
}

message AgentStatusRequest {}

message AgentStatusResponse {
  bool ready = 1;
  string peer_id = 2;
  int32 connected_peers = 3;
  int32 active_handshakes = 4;
  string state = 5;
}

message PeersRequest {}

message PeersResponse {
  repeated PeerInfo peers = 1;
}

message PeerInfo {
  string peer_id = 1;
  repeated string addrs = 2;
  string connection_state = 3;
}

message BootstrapRequest {
  string multiaddr = 1;
}

message BootstrapResponse {
  bool success = 1;
  string error = 2;
  string peer_id = 3;
}

message IdentityRequest {}

message IdentityResponse {
  string peer_id = 1;
  string did = 2;
  repeated string listen_addrs = 3;
}
